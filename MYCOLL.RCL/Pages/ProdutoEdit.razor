@page "/admin/produtos/edit/{Id:int?}"
@using MYCOLL.RCL.Data.DTO
@using MYCOLL.RCL.Services
@inject MYCOLL.RCL.Data.Interfaces.IProdutoService ProdutoService
@inject SubCategoriaService SubCategoriaService
@inject NavigationManager NavManager

@attribute [Authorize(Roles = "Funcionario")]


<AuthorizeView>
    <Authorized Context="authCtx">
        <h3>@(Id == null ? "Novo Produto" : "Editar Produto")</h3>

        <EditForm Model="produto" OnValidSubmit="Save">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label>Nome</label>
                <InputText @bind-Value="produto.Nome" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Descrição</label>
                <InputTextArea @bind-Value="produto.Descricao" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Preço</label>
                <InputNumber @bind-Value="produto.Preco" class="form-control" />
            </div>

            <div class="mb-3">
                <label>Stock</label>
                <InputNumber @bind-Value="produto.Stock" class="form-control" />
            </div>

            <div class="mb-3">
                <label for="categoriaid" class="form-label">Categoria:</label>
                <InputSelect id="categoriaid" class="form-select" @bind-Value="@produto.SubcategoriaId">
                    <option value="-1">Escolha uma Categoria</option>
                    @foreach (var item in selSubCategorias)
                    {
                        <option value="@item.Id">@item.Nome</option>
                    }
                </InputSelect>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="text-danger">@errorMessage</div>
                }
                <ValidationMessage For="() => produto.SubcategoriaId" class="text-danger" />
            </div>

            <!-- Upload de Imagem -->
            <div class="mb-3">
                <label>Imagem</label>
                <InputFile OnChange="CarregarImagem" class="form-control" />
                @if (produto.Imagem != null)
                {
                    <p class="mt-2 text-success">Imagem carregada!</p>
                }
            </div>

            <button class="btn btn-primary mt-3" type="submit">Guardar</button>
            <button class="btn btn-secondary mt-3" type="button" @onclick="Cancel">Cancelar</button>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <p>Acesso negado.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int? Id { get; set; }
    private ProdutoDTO produto = new ProdutoDTO();

    IEnumerable<SubCategoria> selSubCategorias = Enumerable.Empty<SubCategoria>();

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        selSubCategorias = await SubCategoriaService.GetSubCategorias();
        if (Id != null)
        {
            var existing = await ProdutoService.GetProdutoByIdAsync(Id.Value);
            if (existing != null) produto = existing;
        }
        else
        {
            produto.EstadoProduto = "Pendente"; // Fornecedores criam como Pendente
            produto.Tipo = "Venda";
        }
    }

    private async Task CarregarImagem(InputFileChangeEventArgs e)
    {
        try
        {
            var ficheiro = e.File;

            //Criar um stream de memória
            using var stream = new MemoryStream();

            await ficheiro.OpenReadStream(maxAllowedSize: 1024 * 1024 * 10) // 10MB
                .CopyToAsync(stream);

            //Converter para array de bytes
            produto.Imagem = stream.ToArray();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro no upload: {ex.Message}");
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrEmpty(produto.URLImagem))
        {
            produto.URLImagem = "temp.jpg"; // Para substituir depois com a imagem real
        }

        if (Id == null)
        {
            await ProdutoService.CreateProdutoAsync(produto);
        }
        else
        {
            await ProdutoService.UpdateProdutoAsync(produto);
        }
        NavManager.NavigateTo("/admin/produtos");
    }

    private void Cancel() => NavManager.NavigateTo("/admin/produtos");
}