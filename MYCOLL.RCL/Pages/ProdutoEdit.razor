@page "/admin/produtos/edit/{Id:int?}"
@using MYCOLL.RCL.Data.DTO
@inject MYCOLL.RCL.Data.Interfaces.IProdutoService ProdutoService
@inject NavigationManager NavManager

<AuthorizeView>
    <Authorized Context="authCtx">
        <EditForm Model="produto" OnValidSubmit="Save" Context="editCtx">
            <DataAnnotationsValidator />

            <InputText @bind-Value="produto.Nome" class="form-control" />
            <InputTextArea @bind-Value="produto.Descricao" class="form-control mt-2" />
            <InputNumber @bind-Value="produto.Preco" class="form-control mt-2" />

            <button class="btn btn-primary mt-3" type="submit">Guardar</button>
            <button class="btn btn-secondary mt-3" type="button" @onclick="Cancel">Cancelar</button>
        </EditForm>
    </Authorized>
    <NotAuthorized>
        <p>Acesso restrito a funcionários.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int? Id { get; set; }
    private ProdutoDTO produto = new ProdutoDTO();

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            var existing = await ProdutoService.GetProdutoByIdAsync(Id.Value);
            if (existing != null) produto = existing;
        }
    }

    private async Task Save()
    {
        if (Id == null)
        {
            var created = await ProdutoService.CreateProdutoAsync(produto);
            if (created != null) NavManager.NavigateTo("/admin/produtos");
        }
        else
        {
            var updated = await ProdutoService.UpdateProdutoAsync(produto);
            if (updated != null) NavManager.NavigateTo("/admin/produtos");
        }
    }

    private void Cancel() => NavManager.NavigateTo("/admin/produtos");
}